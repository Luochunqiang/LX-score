<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>æ¥å›</title>
    
    <style>
        :root {
            --bg-body: #f5f5f7;
            --bg-card: #ffffff;
            --bg-input: #f2f2f7;
            --text-main: #1d1d1f;
            --text-sub: #86868b;
            --border: rgba(0,0,0,0.08);
            --accent-a: #007aff;
            --accent-b: #bf5af2;
            --accent-c: #34c759;
            --accent-d: #ff9500;
            --accent-gold: #ffcc00;
            --accent-red: #ff3b30;
            --accent-green: #34c759;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --ease-spring: cubic-bezier(0.2, 0.8, 0.2, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --anim-duration: 0.3s;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        [data-skin="dark"] {
            --bg-body: #1a1a1a;
            --bg-card: #2c2c2e;
            --bg-input: #3a3a3c;
            --text-main: #f5f5f7;
            --text-sub: #a1a1a6;
            --border: rgba(255,255,255,0.1);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
        }

        [data-skin="eye"] {
            --bg-body: #f0f8f0;
            --bg-card: #ffffff;
            --bg-input: #e8f4e8;
            --text-main: #2d5a2d;
            --text-sub: #6a8b6a;
            --border: rgba(45,90,45,0.1);
            --shadow-sm: 0 2px 8px rgba(45,90,45,0.05);
            --shadow-md: 0 4px 12px rgba(45,90,45,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background: var(--bg-body);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            height: 100vh; height: 100dvh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: all var(--anim-duration) var(--ease-smooth);
        }

        .num-font { font-family: "SF Pro Display", sans-serif; font-feature-settings: "tnum"; font-variant-numeric: tabular-nums; }

        .header {
            padding: calc(12px + var(--safe-top)) 20px 12px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 50; border-bottom: 1px solid var(--border);
        }
        .logo { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; opacity: 0.9; }
        
        .action-group { display: flex; gap: 12px; }
        .icon-btn {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--bg-input); border: none;
            font-size: 17px; display: flex; align-items: center; justify-content: center;
            color: var(--text-main);
            transition: transform 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); }

        .main-scroll {
            flex: 1; overflow-y: auto; padding: 16px;
            display: flex; flex-direction: column; gap: 16px;
            overscroll-behavior: contain;
            scrollbar-width: none;
        }

        .score-board { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            transition: all var(--anim-duration) var(--ease-smooth);
        }
        .score-board.mode-4p { grid-template-rows: 1fr 1fr; }
        
        .card {
            background: var(--bg-card); border-radius: 18px;
            padding: 16px 10px; box-shadow: var(--shadow-sm);
            display: flex; flex-direction: column; align-items: center;
            transition: all var(--anim-duration) var(--ease-spring);
            border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }
        .card-a { border-top: 3px solid var(--accent-a); }
        .card-b { border-top: 3px solid var(--accent-b); }
        .card-c { border-top: 3px solid var(--accent-c); }
        .card-d { border-top: 3px solid var(--accent-d); }
        
        .target-tip {
            font-size: 11px; color: var(--text-sub);
            margin-bottom: 4px; padding: 2px 8px;
            border-radius: 4px; background: var(--bg-input);
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .target-tip.warn { 
            color: #fff; background: var(--accent-red); font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; transform: scale(0.98); } 100% { opacity: 1; } }

        .team-input {
            width: 100%; text-align: center; font-size: 16px; font-weight: 600;
            border: none; outline: none; background: transparent; color: var(--text-main);
            margin-bottom: 4px; padding: 4px 0;
        }
        
        .score-display { 
            font-size: 58px; font-weight: 700; letter-spacing: -2px; line-height: 1; margin: 8px 0 16px;
        }
        .card-a .score-display { color: var(--accent-a); }
        .card-b .score-display { color: var(--accent-b); }
        .card-c .score-display { color: var(--accent-c); }
        .card-d .score-display { color: var(--accent-d); }
        /* âœ… æ–°å¢ï¼šæ€»åˆ†å˜åŠ¨åŠ¨ç”»ï¼ˆç¼©æ”¾é—ªçƒï¼‰ */
        .score-animate { animation: scorePulse 0.5s ease-in-out; }
        @keyframes scorePulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

        .tags-row { display: flex; gap: 6px; justify-content: center; }
        .tag {
            font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 100px;
            background: var(--bg-input); color: var(--text-sub);
        }
        .tag.xi { color: var(--accent-gold); }

        .list-card {
            background: var(--bg-card); border-radius: 18px; box-shadow: var(--shadow-sm);
            flex: 1; min-height: 150px; display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .list-head {
            padding: 14px 16px; font-size: 12px; font-weight: 600; color: var(--text-sub);
            text-transform: uppercase; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; background: var(--bg-card);
        }
        .time-display { font-family: "SF Pro Display", monospace; color: var(--accent-a); font-weight: 600; }
        
        .list-body { flex: 1; overflow-y: auto; padding-bottom: 20px; scrollbar-width: none; }
        .list-empty { padding: 40px; text-align: center; color: var(--text-sub); font-size: 14px; opacity: 0.7; }
        
        .row {
            padding: 12px 16px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 17px; animation: slideIn 0.3s var(--ease-out);
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

        .row-idx { width: 32px; font-size: 13px; color: var(--text-sub); font-weight: 500; text-align: center; }
        .row-content { flex: 1; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .row-val { font-weight: 600; width: 60px; text-align: center; }
        .row-val.a { color: var(--accent-a); }
        .row-val.b { color: var(--accent-b); }
        .row-val.c { color: var(--accent-c); }
        .row-val.d { color: var(--accent-d); }
        .row-val.neg { color: var(--accent-red) !important; }
        .row-xi { font-size: 11px; color: var(--accent-gold); vertical-align: top; margin-left: 2px; }

        .controls {
            background: var(--bg-card);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            padding: 16px 16px calc(16px + var(--safe-bottom));
            border-top: 1px solid var(--border);
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px var(--shadow-sm);
            z-index: 100;
        }
        
        .input-area { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 10px; }
        .input-area.mode-4p { grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; }
        
        .input-pill {
            background: var(--bg-input); border-radius: 14px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid var(--border); transition: transform 0.2s;
        }
        .input-pill:focus-within { transform: translateY(-2px); border-color: var(--accent-a); }
        
        .xi-stepper { display: flex; width: 100%; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .step-btn {
            width: 28px; height: 28px; border-radius: 8px; background: var(--bg-card);
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; border: 1px solid var(--border);
        }
        .xi-val { font-size: 13px; font-weight: 700; }

        .big-input {
            width: 100%; border: none; background: transparent; text-align: center;
            font-size: 26px; font-weight: 600; outline: none; padding: 4px 0; color: var(--text-main);
        }
        .neg-btn {
            font-size: 10px; font-weight: 600; color: var(--text-sub);
            background: var(--bg-card); padding: 4px 12px; border-radius: 10px; border: 1px solid var(--border);
        }
        
        /* å®æ—¶æ ¡éªŒæ¡ï¼ˆè´Ÿåˆ†-160~560ï¼Œæ— è´Ÿåˆ†åˆè®¡â‰¤400ï¼‰ */
        .check-bar {
            display: flex; justify-content: center; align-items: center;
            font-size: 13px; font-weight: 600; margin-bottom: 12px;
            height: 24px; transition: color 0.3s; gap: 6px;
        }
        .check-bar.valid { color: var(--accent-green); }
        .check-bar.invalid { color: var(--accent-red); }

        .main-btn {
            width: 100%; height: 52px; border-radius: 14px; border: none;
            background: var(--text-main); color: var(--bg-body);
            font-size: 17px; font-weight: 600; box-shadow: var(--shadow-sm);
        }
        .main-btn:active { transform: scale(0.96); }
        .main-btn:disabled { background: var(--text-sub); opacity: 0.7; transform: none; }
        
        .settle-link {
            text-align: center; margin-top: 14px; font-size: 14px;
            color: var(--accent-a); font-weight: 500;
        }

        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 200; opacity: 0; pointer-events: none; 
            transition: opacity var(--anim-duration);
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal-mask.show { opacity: 1; pointer-events: auto; }
        
        .modal-sheet {
            width: 100%; max-width: 600px; margin: 0 auto;
            background: var(--bg-card); border-radius: 24px 24px 0 0;
            padding: 24px 20px calc(24px + var(--safe-bottom));
            transform: translateY(100%); transition: transform 0.4s var(--ease-spring);
            max-height: 85vh; overflow-y: auto;
        }
        .modal-mask.show .modal-sheet { transform: translateY(0); }
        
        .sheet-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; text-align: center; }
        
        .settle-card {
            background: var(--bg-input); border-radius: 16px; padding: 20px;
            margin-bottom: 16px; text-align: center; border: 2px solid transparent;
        }
        .settle-card.winner { background: rgba(255, 204, 0, 0.1); border-color: var(--accent-gold); }
        .winner-icon { font-size: 40px; margin-bottom: 8px; display: block; }
        .winner-name { font-size: 24px; font-weight: 800; color: var(--text-main); margin-bottom: 4px; }
        .winner-tag { 
            background: var(--accent-gold); color: #fff; padding: 4px 12px; 
            border-radius: 100px; font-size: 12px; font-weight: 700; display: inline-block;
        }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .stat-box { 
            background: var(--bg-card); padding: 12px; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center;
        }
        .stat-val { font-size: 18px; font-weight: 700; }
        .stat-lbl { font-size: 11px; color: var(--text-sub); }

        .sheet-btns { display: flex; gap: 12px; margin-top: 16px; }
        .sheet-btn {
            flex: 1; height: 48px; border-radius: 12px; border: 1px solid var(--border);
            font-size: 16px; font-weight: 600;
            background: var(--bg-input); color: var(--text-main);
        }
        .btn-blue { background: var(--accent-a); color: #fff; border: none; }
        
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: var(--bg-card); color: var(--text-main);
            padding: 12px 24px; border-radius: 50px;
            box-shadow: var(--shadow-md); border: 1px solid var(--border);
            font-size: 14px; font-weight: 600; opacity: 0; pointer-events: none; 
            transition: all 0.4s var(--ease-spring); z-index: 999;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .switch {
            position: relative; width: 50px; height: 30px;
            appearance: none; background: var(--bg-input); border-radius: 15px;
            outline: none; transition: 0.3s;
        }
        .switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 26px; height: 26px; background: var(--bg-card); border-radius: 50%;
            box-shadow: var(--shadow-sm); transition: 0.3s;
        }
        .switch:checked { background: var(--accent-a); }
        .switch:checked::after { transform: translateX(20px); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border); }
        
        .skin-select { display: flex; gap: 8px; }
        .skin-item { width: 28px; height: 28px; border-radius: 8px; border: 2px solid transparent; }
        .skin-item.active { border-color: var(--accent-a); }
        .skin-light { background: #f5f5f7; }
        .skin-dark { background: #1a1a1a; }
        .skin-eye { background: #f0f8f0; }
        
        .history-overview { background: var(--bg-input); border-radius: 16px; padding: 16px; margin-bottom: 20px; }
        .overview-title { font-size: 14px; color: var(--text-sub); margin-bottom: 12px; font-weight: 600; }
        
        /* å†å²è®°å½•é¢œè‰²æ ‡è¯†ï¼ˆä¾§è¾¹æ¡+æ–‡å­—è‰²ï¼Œæ— æ”¹åŠ¨ï¼‰ */
        .hist-item { padding: 12px 0; border-bottom: 1px solid var(--border); border-left: 3px solid transparent; padding-left: 8px; transition: background 0.2s; }
        .hist-item.win-A { border-left-color: var(--accent-a); }
        .hist-item.win-B { border-left-color: var(--accent-b); }
        .hist-item.win-C { border-left-color: var(--accent-c); }
        .hist-item.win-D { border-left-color: var(--accent-d); }
        
        .hist-win-text.win-A { color: var(--accent-a); }
        .hist-win-text.win-B { color: var(--accent-b); }
        .hist-win-text.win-C { color: var(--accent-c); }
        .hist-win-text.win-D { color: var(--accent-d); }
    </style>
</head>
<body ontouchstart="" data-skin="light">

    <header class="header">
        <div class="logo">æ¥å›</div>
        <div class="action-group">
            <button class="icon-btn" onclick="app.showHistory()">ğŸ“Š</button>
            <button class="icon-btn" onclick="app.showSettings()">âš™ï¸</button>
        </div>
    </header>

    <div class="main-scroll">
        <div class="score-board" id="scoreBoard">
            <div class="card card-a">
                <div class="target-tip" id="tipA">ç›®æ ‡1200åˆ†</div>
                <input type="text" class="team-input" id="nameA" value="Aé˜Ÿ" onchange="app.saveConfig()">
                <div class="score-display num-font" id="dispA">0</div>
                <div class="tags-row">
                    <div class="tag"><span id="lvA">0</span>çº§</div>
                    <div class="tag xi">å›<span id="xiA">0</span></div>
                </div>
            </div>
            <div class="card card-b">
                <div class="target-tip" id="tipB">ç›®æ ‡1200åˆ†</div>
                <input type="text" class="team-input" id="nameB" value="Bé˜Ÿ" onchange="app.saveConfig()">
                <div class="score-display num-font" id="dispB">0</div>
                <div class="tags-row">
                    <div class="tag"><span id="lvB">0</span>çº§</div>
                    <div class="tag xi">å›<span id="xiB">0</span></div>
                </div>
            </div>
            <div class="card card-c" id="cardC" style="display: none;">
                <div class="target-tip" id="tipC">ç›®æ ‡1200åˆ†</div>
                <input type="text" class="team-input" id="nameC" value="Cé˜Ÿ" onchange="app.saveConfig()">
                <div class="score-display num-font" id="dispC">0</div>
                <div class="tags-row">
                    <div class="tag"><span id="lvC">0</span>çº§</div>
                    <div class="tag xi">å›<span id="xiC">0</span></div>
                </div>
            </div>
            <div class="card card-d" id="cardD" style="display: none;">
                <div class="target-tip" id="tipD">ç›®æ ‡1200åˆ†</div>
                <input type="text" class="team-input" id="nameD" value="Dé˜Ÿ" onchange="app.saveConfig()">
                <div class="score-display num-font" id="dispD">0</div>
                <div class="tags-row">
                    <div class="tag"><span id="lvD">0</span>çº§</div>
                    <div class="tag xi">å›<span id="xiD">0</span></div>
                </div>
            </div>
        </div>

        <div class="list-card">
            <div class="list-head">
                <span>Current Session</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span class="time-display" id="timeShow">00:00</span>
                    <span id="roundCount" style="opacity:0.6">0 / 10</span>
                </div>
            </div>
            <div class="list-body" id="logList">
                <div class="list-empty">æš‚æ— å¯¹å±€ï¼Œè¯·å¼€å§‹ä½ çš„è¡¨æ¼”</div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="input-area" id="inputArea">
            <div class="input-pill a">
                <div class="xi-stepper">
                    <div class="step-btn" onclick="app.adjXi('A', -1)">-</div>
                    <div class="xi-val" id="tempXiA">0</div>
                    <div class="step-btn" onclick="app.adjXi('A', 1)">+</div>
                </div>
                <input type="number" class="big-input num-font round-in" id="inA" placeholder="0" inputmode="decimal" oninput="app.calcSum()">
                <div class="neg-btn" onclick="app.negate('inA')">+/-</div>
            </div>
            <div class="input-pill b">
                <div class="xi-stepper">
                    <div class="step-btn" onclick="app.adjXi('B', -1)">-</div>
                    <div class="xi-val" id="tempXiB">0</div>
                    <div class="step-btn" onclick="app.adjXi('B', 1)">+</div>
                </div>
                <input type="number" class="big-input num-font round-in" id="inB" placeholder="0" inputmode="decimal" oninput="app.calcSum()">
                <div class="neg-btn" onclick="app.negate('inB')">+/-</div>
            </div>
            <div class="input-pill c" id="inputC" style="display: none;">
                <div class="xi-stepper">
                    <div class="step-btn" onclick="app.adjXi('C', -1)">-</div>
                    <div class="xi-val" id="tempXiC">0</div>
                    <div class="step-btn" onclick="app.adjXi('C', 1)">+</div>
                </div>
                <input type="number" class="big-input num-font round-in" id="inC" placeholder="0" inputmode="decimal" oninput="app.calcSum()">
                <div class="neg-btn" onclick="app.negate('inC')">+/-</div>
            </div>
            <div class="input-pill d" id="inputD" style="display: none;">
                <div class="xi-stepper">
                    <div class="step-btn" onclick="app.adjXi('D', -1)">-</div>
                    <div class="xi-val" id="tempXiD">0</div>
                    <div class="step-btn" onclick="app.adjXi('D', 1)">+</div>
                </div>
                <input type="number" class="big-input num-font round-in" id="inD" placeholder="0" inputmode="decimal" oninput="app.calcSum()">
                <div class="neg-btn" onclick="app.negate('inD')">+/-</div>
            </div>
        </div>
        
        <div class="check-bar" id="checkBar">
            <span id="checkIcon">âš–ï¸</span>
            <span id="checkText">è¯·è¾“å…¥åˆ†æ•°ï¼Œæ— è´Ÿåˆ†åˆè®¡â‰¤400</span>
        </div>

        <button class="main-btn" id="btnCommit" onclick="app.commit()">ç¡®è®¤æäº¤</button>
        <div class="settle-link" onclick="app.preSettle()">ç»“æŸå¹¶ç»“ç®—</div>
    </div>

    <div class="modal-mask" id="modal">
        <div class="modal-sheet" id="modalBody"></div>
    </div>

    <div class="toast" id="toast">
        <span id="toastMsg">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        const app = {
            data: {
                names: { A: 'Aé˜Ÿ', B: 'Bé˜Ÿ', C: 'Cé˜Ÿ', D: 'Dé˜Ÿ' },
                rounds: [],
                tempXi: { A: 0, B: 0, C: 0, D: 0 },
                config: { 
                    target: 1200, reward: 300, max: 10, is4P: false,
                    maxSingle: 560, minSingle: -160, maxTotal: 400, // è´Ÿåˆ†èŒƒå›´æœªæ”¹åŠ¨
                    soundOn: true, skin: 'light'
                },
                isOver: false
            },
            STORAGE_KEY: 'lx_score_full_v11',
            HIST_KEY: 'lx_score_hist_full_v11',
            DRAFT_KEY: 'lx_score_draft_v11',
            
            timerId: null, startTime: 0, elapsedTime: 0, isTimerRunning: false,
            audioCtx: null, soundCache: {},

            init() {
                this.initAudio();
                this.loadStorage();
                this.loadDraft();
                this.initSkin();
                
                ['A','B','C','D'].forEach(k => { 
                    document.getElementById(`name${k}`).value = this.data.names[k] || `${k}é˜Ÿ`; 
                });
                
                this.toggle4PMode(this.data.config.is4P);
                this.updateTargetTip();
                this.calcSum(); // åˆå§‹åŒ–æ ¡éªŒæ¡
                if (!this.data.isOver) {
                    this.startTimer();
                } else {
                    this.updateTimeDisplay();
                }
                this.render();
            },

            initAudio() {
                if (!window.AudioContext) return;
                this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                this.soundCache = {
                    add: () => this.playTone(880, 0.05),
                    commit: () => this.playTone(660, 0.1),
                    win: () => this.playTone(1000, 0.1, 1200, 0.2),
                    alert: () => this.playTone(440, 0.3)
                };
            },
            playTone(freq1, dur1, freq2, dur2) {
                if (!this.data.config.soundOn || !this.audioCtx) return;
                const play = (f, d, delay=0) => {
                    const osc = this.audioCtx.createOscillator();
                    const gain = this.audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(this.audioCtx.destination);
                    osc.frequency.value = f;
                    gain.gain.value = 0.1;
                    osc.start(this.audioCtx.currentTime + delay);
                    gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + delay + d);
                    osc.stop(this.audioCtx.currentTime + delay + d);
                };
                play(freq1, dur1);
                if(freq2) play(freq2, dur2, dur1 * 0.8);
            },
            playSound(type) { if(this.soundCache[type]) this.soundCache[type](); },

            startTimer() {
                if (this.isTimerRunning) return;
                this.startTime = Date.now() - (this.elapsedTime || 0);
                this.isTimerRunning = true;
                this.timerId = setInterval(() => {
                    this.elapsedTime = Date.now() - this.startTime;
                    this.updateTimeDisplay();
                }, 1000);
            },
            stopTimer() {
                if (this.timerId) { clearInterval(this.timerId); this.timerId = null; this.isTimerRunning = false; }
            },
            resetTimer() {
                this.stopTimer(); this.elapsedTime = 0; this.startTime = Date.now();
                this.updateTimeDisplay(); this.startTimer();
            },
            updateTimeDisplay() {
                document.getElementById('timeShow').innerText = this.formatTime(this.elapsedTime, true);
            },
            formatTime(ms, isSimple=false) {
                const totalSec = Math.floor(ms / 1000);
                const mins = Math.floor(totalSec / 60).toString().padStart(2, '0');
                const secs = (totalSec % 60).toString().padStart(2, '0');
                if(isSimple) return `${mins}:${secs}`;
                return mins > 0 ? `${mins}åˆ†${secs}ç§’` : `${secs}ç§’`;
            },

            initSkin() {
                document.body.setAttribute('data-skin', this.data.config.skin);
                document.querySelectorAll('.skin-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.skin === this.data.config.skin);
                });
            },
            changeSkin(skin) {
                this.data.config.skin = skin;
                this.initSkin(); this.saveToStorage();
                this.toast(`å·²åˆ‡æ¢${skin==='light'?'æµ…è‰²':skin==='dark'?'æ·±è‰²':'æŠ¤çœ¼'}æ¨¡å¼`);
            },

            saveDraft() {
                const draft = {
                    rounds: this.data.rounds,
                    tempXi: this.data.tempXi,
                    elapsedTime: this.elapsedTime,
                    isOver: this.data.isOver
                };
                localStorage.setItem(this.DRAFT_KEY, JSON.stringify(draft));
            },
            loadDraft() {
                const draft = JSON.parse(localStorage.getItem(this.DRAFT_KEY) || '{}');
                if (draft.rounds) this.data.rounds = draft.rounds;
                if (draft.tempXi) this.data.tempXi = draft.tempXi;
                if (draft.elapsedTime) this.elapsedTime = draft.elapsedTime;
                if (draft.isOver !== undefined) this.data.isOver = draft.isOver;
            },
            saveConfig() {
                ['A','B','C','D'].forEach(k => { 
                    this.data.names[k] = document.getElementById(`name${k}`).value.trim() || `${k}é˜Ÿ`; 
                });
                this.saveToStorage();
            },
            saveToStorage() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.data)); },
            loadStorage() {
                const saved = localStorage.getItem(this.STORAGE_KEY);
                if (saved) { try { Object.assign(this.data, JSON.parse(saved)); } catch(e){} }
            },

            toggle4PMode(is4P) {
                this.data.config.is4P = is4P;
                const displayStyle = is4P ? 'flex' : 'none';
                ['cardC','cardD','inputC','inputD'].forEach(id => document.getElementById(id).style.display = displayStyle);
                
                const sb = document.getElementById('scoreBoard');
                const ia = document.getElementById('inputArea');
                if (is4P) { sb.classList.add('mode-4p'); ia.classList.add('mode-4p'); } 
                else { sb.classList.remove('mode-4p'); ia.classList.remove('mode-4p'); }
                
                this.saveToStorage(); this.updateTargetTip(); this.calcSum();
            },

            updateTargetTip() {
                const target = this.data.config.target;
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                
                teams.forEach(t => {
                    const score = parseInt(document.getElementById(`disp${t}`).innerText) || 0;
                    const tip = document.getElementById(`tip${t}`);
                    const diff = target - score;
                    if (diff <= 200 && diff > 0) {
                        tip.classList.add('warn'); tip.innerHTML = `âš ï¸ èµ›ç‚¹ï¼å·®${diff}åˆ†`; this.playSound('alert');
                    } else {
                        tip.classList.remove('warn'); tip.innerHTML = `ç›®æ ‡${target}åˆ†`;
                    }
                });
            },

            adjXi(team, d) {
                if(this.data.isOver) return this.toast('ğŸš« æˆ˜å±€å·²ç»“æŸ');
                const v = Math.max(0, Math.min(10, this.data.tempXi[team] + d));
                this.data.tempXi[team] = v;
                document.getElementById(`tempXi${team}`).innerText = v;
                this.playSound('add'); this.saveDraft();
            },
            negate(id) {
                if(this.data.isOver) return;
                const el = document.getElementById(id);
                if(el.value) {
                    el.value = parseFloat(el.value) * -1;
                    this.calcSum(); this.playSound('add');
                }
            },

            // å®æ—¶æ ¡éªŒé€»è¾‘ï¼ˆæ— æ”¹åŠ¨ï¼Œè´Ÿåˆ†-160~560ï¼Œæ— è´Ÿåˆ†åˆè®¡â‰¤400ï¼‰
            calcSum() {
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                const scores = teams.map(t => parseInt(document.getElementById(`in${t}`).value) || 0);
                const sum = scores.reduce((acc, curr) => acc + curr, 0);
                const hasNegative = scores.some(s => s < 0);

                const bar = document.getElementById('checkBar');
                const icon = document.getElementById('checkIcon');
                const txt = document.getElementById('checkText');
                let isValid = true;
                let tipText = '';

                if (hasNegative) {
                    const overLimit = scores.some(s => s < this.data.config.minSingle || s > this.data.config.maxSingle);
                    isValid = !overLimit;
                    tipText = `æœ‰è´Ÿåˆ†ï½œå•å±€é™${this.data.config.minSingle}~${this.data.config.maxSingle}`;
                } else {
                    isValid = sum <= this.data.config.maxTotal;
                    tipText = `æ— è´Ÿåˆ†ï½œåˆè®¡â‰¤${this.data.config.maxTotal}ï¼ˆå½“å‰${sum}ï¼‰`;
                }

                if (isValid) {
                    bar.classList.add('valid'); bar.classList.remove('invalid');
                    icon.innerText = 'âœ…';
                } else {
                    bar.classList.remove('valid'); bar.classList.add('invalid');
                    icon.innerText = 'âš ï¸';
                }
                txt.innerText = tipText;
                return isValid;
            },

            // æäº¤é€»è¾‘ï¼ˆæ— æ”¹åŠ¨ï¼‰
            commit() {
                if(this.data.isOver) return this.toast('ğŸš« æˆ˜å±€å·²ç»“æŸï¼Œè¯·ç»“ç®—');
                if(!this.calcSum()) return this.toast('âŒ åˆ†æ•°è¶…é™ï¼Œä¸ç¬¦åˆè§„åˆ™ï¼');
                
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                const roundData = {};
                
                teams.forEach(t => {
                    const el = document.getElementById(`in${t}`);
                    roundData[`s${t}`] = parseInt(el.value || 0);
                    roundData[`x${t}`] = this.data.tempXi[t];
                    el.value = ''; this.data.tempXi[t] = 0;
                    document.getElementById(`tempXi${t}`).innerText = '0';
                });
                
                if(this.data.rounds.length >= this.data.config.max) return this.toast(`âš ï¸ å·²è¾¾æœ€å¤§${this.data.config.max}å±€`);
                
                this.data.rounds.push(roundData);
                this.playSound('commit');
                this.render();
                this.calcSum(); // é‡ç½®æ ¡éªŒæ¡
                
                const list = document.querySelector('.list-body');
                setTimeout(() => { list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' }); }, 50);

                const stats = this.calc();
                if(stats.winner) {
                    this.data.isOver = true;
                    this.stopTimer();
                    this.saveDraft();
                    this.render();
                    this.playSound('win');
                    setTimeout(() => { this.preSettle(); }, 800);
                } else {
                    this.saveDraft();
                }
            },

            // è®¡ç®—çº§æ•°é€»è¾‘ï¼ˆæ— æ”¹åŠ¨ï¼‰
            calc() {
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                const res = {}; let winner = null;
                teams.forEach(t => { res[t] = { sc:0, xi:0, lv:0, hit:false }; });

                this.data.rounds.forEach(r => {
                    teams.forEach(t => { res[t].sc += (r[`s${t}`] || 0); res[t].xi += (r[`x${t}`] || 0); });
                });

                teams.forEach(t => {
                    res[t].hit = res[t].sc >= this.data.config.target;
                    const finalSc = res[t].hit ? res[t].sc + this.data.config.reward : res[t].sc;
                    res[t].lv = Math.floor(finalSc / 100) + res[t].xi;
                    if (res[t].hit && !winner) winner = t;
                });

                res.winner = winner;
                return res;
            },

            // âœ… ä»…æ­¤å¤„åŠ åŠ¨ç”»è§¦å‘ï¼Œå…¶ä½™æ— æ”¹åŠ¨
            render() {
                const s = this.calc();
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];

                teams.forEach(t => {
                    const dispEl = document.getElementById(`disp${t}`);
                    // åˆ†æ•°æ›´æ–°æ—¶è§¦å‘åŠ¨ç”»
                    dispEl.innerText = s[t].sc;
                    dispEl.classList.add('score-animate');
                    setTimeout(() => dispEl.classList.remove('score-animate'), 500);
                    
                    document.getElementById(`lv${t}`).innerText = s[t].lv;
                    document.getElementById(`xi${t}`).innerText = s[t].xi;
                });
                document.getElementById('roundCount').innerText = `${this.data.rounds.length} / ${this.data.config.max}`;
                
                this.updateTargetTip();
                
                const btn = document.getElementById('btnCommit');
                btn.disabled = this.data.isOver;
                btn.innerText = this.data.isOver ? "æˆ˜å±€ç»“æŸ (å·²è¾¾æ ‡)" : "æäº¤åˆ†æ•°";

                const list = document.getElementById('logList');
                if(!this.data.rounds.length) {
                    list.innerHTML = `<div class="list-empty">æš‚æ— å¯¹å±€è®°å½•</div>`;
                } else {
                    list.innerHTML = this.data.rounds.map((r, i) => {
                        let rowContent = '';
                        teams.forEach(t => {
                            const val = r[`s${t}`] || 0;
                            const xi = r[`x${t}`] || 0;
                            rowContent += `<div class="row-val ${t} ${val<0?'neg':''}">${val}${xi?`<span class="row-xi">å›${xi}</span>`:''}</div>`;
                        });
                        return `<div class="row num-font"><div class="row-idx">${i+1}</div><div class="row-content">${rowContent}</div></div>`;
                    }).join('');
                }
            },

            // ç»“ç®—é€»è¾‘ï¼ˆæ— æ”¹åŠ¨ï¼‰
            preSettle() {
                if(!this.data.rounds.length) return this.toast('âš ï¸ æ— å¯¹å±€æ•°æ®');
                
                const s = this.calc();
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                const winner = s.winner;
                
                let winnerHtml = winner ? 
                    `<div class="settle-card winner"><span class="winner-icon">ğŸ†</span><div class="winner-name">${this.esc(this.data.names[winner])}</div><div class="winner-tag">èƒœåˆ©è¾¾æ ‡ï¼ˆå¥–åŠ±${this.data.config.reward}åˆ†ï¼‰</div><div style="margin-top:8px;font-size:14px;color:var(--text-sub)">æœ€ç»ˆçº§æ•° <span style="font-weight:700;color:var(--text-main)">${s[winner].lv}</span></div></div>` : 
                    `<div class="settle-card"><span class="winner-icon">ğŸ¤</span><div class="winner-name">å¹³å±€ / æœªç»“æŸ</div></div>`;

                let statHtml = '';
                teams.forEach(t => {
                    if (t === winner) return;
                    statHtml += `<div class="stat-box"><div class="stat-val" style="color:var(--accent-${t.toLowerCase()})">${s[t].lv}</div><div class="stat-lbl">${this.esc(this.data.names[t])} (çº§)</div></div>`;
                });

                this.modal(`
                    <div class="sheet-title">æœ¬å±€ç»“ç®—</div>${winnerHtml}
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-val">${this.formatTime(this.elapsedTime, true)}</div><div class="stat-lbl">æ€»è€—æ—¶</div></div>
                        <div class="stat-box"><div class="stat-val">${this.data.rounds.length}</div><div class="stat-lbl">å›åˆæ•°</div></div>
                        ${statHtml}
                    </div>
                    <div class="sheet-btns">
                        <button class="sheet-btn" onclick="app.closeModal()">å–æ¶ˆ</button>
                        <button class="sheet-btn btn-blue" onclick="app.archive()">å°å­˜å¹¶æ–°å¼€</button>
                    </div>
                `);
            },

            // å­˜æ¡£é€»è¾‘ï¼ˆæ— æ”¹åŠ¨ï¼‰
            archive() {
                const s = this.calc();
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                const scores = teams.map(t => s[t].sc);
                const diff = Math.max(...scores) - Math.min(...scores);

                const history = JSON.parse(localStorage.getItem(this.HIST_KEY) || '[]');
                history.unshift({
                    date: new Date().toLocaleString(),
                    mode: is4P ? 4 : 2,
                    names: JSON.parse(JSON.stringify(this.data.names)),
                    levels: { A: s.A.lv, B: s.B.lv, C: s.C?.lv, D: s.D?.lv },
                    scores: { A: s.A.sc, B: s.B.sc, C: s.C?.sc, D: s.D?.sc },
                    winner: s.winner || "Draw",
                    duration: this.formatTime(this.elapsedTime),
                    diff: diff
                });
                localStorage.setItem(this.HIST_KEY, JSON.stringify(history));
                
                this.data.rounds = []; this.data.tempXi = {A:0,B:0,C:0,D:0}; this.data.isOver = false;
                localStorage.removeItem(this.DRAFT_KEY);
                this.resetTimer(); this.saveToStorage(); this.render(); this.closeModal(); this.toast('ğŸ“¦ å·²å°å­˜ï¼Œæ–°å±€å¼€å§‹');
            },
            
            // å†å²æ€»è§ˆï¼ˆæ— æ”¹åŠ¨ï¼‰
            showHistory() {
                const history = JSON.parse(localStorage.getItem(this.HIST_KEY) || '[]');
                if(!history.length) return this.modal('<div class="sheet-title">å†å²æˆ˜ç»©</div><div style="text-align:center;padding:20px;color:var(--text-sub)">æš‚æ— è®°å½•</div><div class="sheet-btns"><button class="sheet-btn" onclick="app.closeModal()">å…³é—­</button></div>');

                const totalGames = history.length;
                const is4P = this.data.config.is4P;
                const teams = is4P ? ['A','B','C','D'] : ['A','B'];
                
                // 1. åˆ†å¼€å±•ç¤ºå„é˜Ÿæ€»çº§æ•°ï¼ˆåˆ é™¤æ€»åˆï¼Œå•ç‹¬æ˜¾ç¤ºï¼‰
                let teamTotalLevels = { A:0, B:0, C:0, D:0 };
                history.forEach(h => teams.forEach(t => teamTotalLevels[t] += h.levels[t] || 0));
                
                // 2. æ€»ç›¸å·®çº§æ•°æ˜ç¡®æ ‡æ³¨ã€ŒXé˜Ÿ-Yé˜Ÿã€ï¼ˆæœ€é«˜-æœ€ä½ï¼‰
                const levelList = teams.map(t => ({ team: t, level: teamTotalLevels[t] }));
                const maxTeam = levelList.sort((a,b) => b.level - a.level)[0];
                const minTeam = levelList.sort((a,b) => a.level - b.level)[0];
                const totalDiffText = `${maxTeam.team}é˜Ÿ(${maxTeam.level}) - ${minTeam.team}é˜Ÿ(${minTeam.level}) = ${maxTeam.level - minTeam.level}`;

                // 3. ç»„è£…å•é˜Ÿçº§æ•°å±•ç¤ºï¼ˆå¸¦ä¸“å±è‰²ï¼Œæ— æ€»åˆï¼‰
                let teamStatHtml = '';
                teams.forEach(t => {
                    const color = `var(--accent-${t.toLowerCase()})`;
                    teamStatHtml += `
                        <div class="stat-box">
                            <div class="stat-val" style="color:${color}">${teamTotalLevels[t]}</div>
                            <div class="stat-lbl">${t}é˜Ÿæ€»çº§æ•°</div>
                        </div>
                    `;
                });

                // å†å²æ€»è§ˆï¼ˆä»…å«ï¼šæ€»å±€æ•°+å„é˜Ÿçº§æ•°+æ˜ç¡®ç›¸å·®æ–¹ï¼‰
                const overviewHtml = `
                    <div class="history-overview">
                        <div class="overview-title">æˆ˜ç»©æ€»è§ˆ</div>
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="stat-val">${totalGames}</div>
                                <div class="stat-lbl">æ€»å±€æ•°</div>
                            </div>
                            ${teamStatHtml}
                            <div class="stat-box" style="grid-column: 1/3">
                                <div class="stat-val">${totalDiffText}</div>
                                <div class="stat-lbl">æ€»ç›¸å·®çº§æ•°</div>
                            </div>
                        </div>
                    </div>
                `;

                // å†å²åˆ—è¡¨ï¼ˆæ— æ”¹åŠ¨ï¼Œä¿ç•™åŸæœ‰æ ·å¼ï¼‰
                const listHtml = history.map(h => {
                    const histTeams = h.mode === 4 ? ['A','B','C','D'] : ['A','B'];
                    const details = histTeams.map(t => {
                        const isWin = h.winner === t;
                        return `<span style="margin-right:8px; color:${isWin?'var(--text-main)':'var(--text-sub)'}; font-weight:${isWin?'700':'400'}">${this.esc(h.names[t])}:${h.levels[t]}çº§</span>`;
                    }).join('');

                    let winClass = '', winTextClass = '', winLabel = 'å¹³å±€/æœªå®Œ';
                    if (h.winner && h.winner !== 'Draw') {
                        winClass = `win-${h.winner}`;
                        winTextClass = `win-${h.winner}`;
                        winLabel = `ğŸ† ${this.esc(h.names[h.winner])} èƒœ`;
                    }

                    return `
                        <div class="hist-item ${winClass}">
                            <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-sub);margin-bottom:4px">
                                <span>${h.date.split(' ')[0]}</span>
                                <span>åˆ†å·® ${h.diff || '-'}</span>
                            </div>
                            <div class="hist-win-text ${winTextClass}" style="font-weight:700;font-size:16px;margin-bottom:4px">${winLabel}</div>
                            <div style="font-size:13px">${details}</div>
                        </div>
                    `;
                }).join('');
                
                this.modal(`
                    <div class="sheet-title">å†å²æˆ˜ç»©</div>
                    ${overviewHtml}
                    <div style="max-height:40vh;overflow-y:auto">${listHtml}</div>
                    <div class="sheet-btns">
                        <button class="sheet-btn" style="color:red" onclick="if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')){localStorage.removeItem(app.HIST_KEY);app.showHistory()}">æ¸…ç©º</button>
                        <button class="sheet-btn" onclick="app.closeModal()">å…³é—­</button>
                    </div>
                `);
            },

            // è®¾ç½®é€»è¾‘ï¼ˆæ— æ”¹åŠ¨ï¼‰
            showSettings() {
                this.modal(`
                    <div class="sheet-title">ç³»ç»Ÿè®¾ç½®</div>
                    <div class="setting-row">
                        <span>çš®è‚¤æ¨¡å¼</span>
                        <div class="skin-select">
                            <div class="skin-item skin-light ${this.data.config.skin==='light'?'active':''}" data-skin="light" onclick="app.changeSkin('light')"></div>
                            <div class="skin-item skin-dark ${this.data.config.skin==='dark'?'active':''}" data-skin="dark" onclick="app.changeSkin('dark')"></div>
                            <div class="skin-item skin-eye ${this.data.config.skin==='eye'?'active':''}" data-skin="eye" onclick="app.changeSkin('eye')"></div>
                        </div>
                    </div>
                    <div class="setting-row">
                        <span>å››äººå¯¹æˆ˜æ¨¡å¼</span>
                        <input type="checkbox" class="switch" ${this.data.config.is4P?'checked':''} onchange="app.toggle4PMode(this.checked)">
                    </div>
                    <div style="margin-top:10px">
                        <div style="font-size:12px;color:var(--text-sub);margin-bottom:4px">è¾¾æ ‡ç»“æŸåˆ†æ•°</div>
                        <input id="cfgT" type="number" value="${this.data.config.target}" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input)">
                    </div>
                    <div style="margin-top:10px">
                        <div style="font-size:12px;color:var(--text-sub);margin-bottom:4px">è¾¾æ ‡å¥–åŠ±åˆ†æ•°ï¼ˆé»˜è®¤300=3çº§ï¼‰</div>
                        <input id="cfgR" type="number" value="${this.data.config.reward}" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input)">
                    </div>
                    <div class="sheet-btns" style="margin-top:16px">
                        <button class="sheet-btn btn-blue" onclick="app.updateConfig()">ä¿å­˜è®¾ç½®</button>
                    </div>
                `);
            },
            updateConfig() {
                const t = parseInt(document.getElementById('cfgT').value);
                const r = parseInt(document.getElementById('cfgR').value);
                if(t>0 && r>=0) {
                    this.data.config.target = t;
                    this.data.config.reward = r;
                    this.saveToStorage(); this.updateTargetTip(); this.calcSum();
                    this.closeModal(); this.toast('âœ… è®¾ç½®å·²ä¿å­˜');
                } else this.toast('âš ï¸ æ•°å€¼éœ€å¤§äº0ï¼ˆå¥–åŠ±åˆ†â‰¥0ï¼‰');
            },
            esc(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); },
            modal(html) { document.getElementById('modalBody').innerHTML = html; document.getElementById('modal').classList.add('show'); },
            closeModal() { document.getElementById('modal').classList.remove('show'); },
            toast(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000);
            }
        };

        app.init();
        document.getElementById('modal').addEventListener('click', e => e.target.id === 'modal' && app.closeModal());
        window.addEventListener('beforeunload', () => app.saveDraft());
    </script>
</body>
</html>